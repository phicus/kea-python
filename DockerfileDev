# syntax=docker/dockerfile:1

FROM debian:bullseye-slim AS build

ARG VER
ENV DEBIAN_FRONTEND noninteractive

WORKDIR /source
COPY kea-$VER.tar.gz .

RUN apt-get update -y \
    && apt-get -y install --no-install-recommends \
        build-essential \
        libboost-system-dev \
        libkrb5-dev \
        liblog4cplus-dev \
        libmariadb-dev \
        libmariadb-dev-compat \
        libssl-dev=1.1.1* \
        libpython3-dev \
        postgresql-server-dev-all \
        python3-pytest \
        python3-setuptools \
    && tar xzf kea-$VER.tar.gz \
    && cd kea-$VER \
    && ./configure \
        --enable-shell \
        --with-site-packages=/usr/lib/python3/dist-packages \
        --enable-perfdhcp \
        --enable-generate-messages \
        --with-mysql=/usr/bin/mysql_config \
        --with-pgsql=/usr/bin/pg_config \
    && make --silent --jobs=$(nproc) \
    && make install \
    && ldconfig \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* /source